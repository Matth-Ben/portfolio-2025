---
import { getImageUrl } from '../utils/media';

interface Props {
  projects: any[];
}

const { projects } = Astro.props;
---

<div class="project-carousel relative">
    <!-- Conteneur du carrousel -->
    <div class="carousel-container overflow-hidden">
        <div class="carousel-track flex transition-transform duration-500 ease-in-out" id="carousel-track">
            {projects.length > 1 && (
                <div class="carousel-slide min-w-full flex-shrink-0">
                    <div class="relative h-dvh bg-gradient-to-br from-gray-900 to-gray-800">
                                            <!-- Image de fond du projet -->
                        {projects[projects.length - 1].featuredImage && (
                        <img 
                            src={getImageUrl(projects[projects.length - 1].featuredImage)}
                            alt={projects[projects.length - 1].title || 'Projet'}
                            class="absolute inset-0 w-full h-full object-cover opacity-40"
                        />
                        )}
                        
                        <!-- Overlay avec contenu -->
                        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                    </div>
                </div>
            )}
            
            {/* Projets originaux */}
            {projects.map((project, index) => (
                <div class="carousel-slide min-w-full flex-shrink-0">
                    <div class="relative h-dvh bg-gradient-to-br from-gray-900 to-gray-800">
                        <!-- Image de fond du projet -->
                        {project.featuredImage && (
                        <img 
                            src={getImageUrl(project.featuredImage)}
                            alt={project.title || 'Projet'}
                            class="absolute inset-0 w-full h-full object-cover opacity-40"
                        />
                        )}
                        
                        <!-- Overlay avec contenu -->
                        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                    </div>
                </div>
            ))}
            
            {/* Clone du premier projet à la fin pour l'effet de boucle */}
            {projects.length > 1 && (
                <div class="carousel-slide min-w-full flex-shrink-0">
                    <div class="relative h-dvh bg-gradient-to-br from-gray-900 to-gray-800">
                        <!-- Image de fond du projet -->
                        {projects[0].featuredImage && (
                        <img 
                            src={getImageUrl(projects[0].featuredImage)}
                            alt={projects[0].title || 'Projet'}
                            class="absolute inset-0 w-full h-full object-cover opacity-40"
                        />
                        )}
                        
                        <!-- Overlay avec contenu -->
                        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
                    </div>
                </div>
            )}
        </div>
    </div>

         <!-- Navigation et informations -->
    {projects.length > 1 && (
        <div class="absolute top-1/2 left-0 right-0 px-[1rem] md:px-[2rem]">
            <div class="relative">
                <div class="relative w-full h-[1px] bg-[#EAE8DE] opacity-30"></div>
                <div class="progress-bar absolute top-0 left-0 h-full bg-white w-full translate-y-1/2" style="transform: scaleX(0); transform-origin: left;"></div>
            </div>
            <div class="grid grid-cols-8 md:grid-cols-12 gap mt-[2rem]">
                <div class="col-span-8 md:col-span-5 lg:col-span-3 xl:col-span-2 md:col-start-8 lg:col-start-10 xl:col-start-11 flex flex-col items-end">
                    {/* Titres des projets et numéro */}
                    <div class="flex flex-col items-end gap-[1rem] text-white w-full">
                        <div class="project-info flex items-start justify-between gap-[1rem] w-full">
                            <div class="project-title flex-1">
                                {projects[0].title || 'Projet sans titre'}
                            </div>
                            <p class="text-sm opacity-70 project-counter">
                                01 / 0{projects.length}
                            </p>
                        </div>
                        
                        {/* Bouton Discover */}
                        {projects[0].slug && (
                            <a 
                                href={`/projects/${projects[0].slug}`}
                                class="discover-btn"
                            >
                                Discover
                            </a>
                        )}
                    </div>
                    
                    {/* Boutons de navigation */}
                    <div class="w-full mt-[1.5rem]">
                        <div class="flex items-center justify-between">
                            <button 
                                class="carousel-btn carousel-btn-prev text-white hover:text-gray-300 transition-colors"
                                aria-label="Projet précédent"
                            >
                                Previous
                            </button>
                            
                            <button 
                                class="carousel-btn carousel-btn-next text-white hover:text-gray-300 transition-colors"
                                aria-label="Projet suivant"
                            >
                                Next
                            </button>
                        </div>
                    </div>
                    
                    {/* Bouton All projects */}
                    <div class="mt-[1rem]">
                        <a 
                            href="/projects"
                            class="all-projects-btn flex items-center gap-[1rem] text-white"
                        >
                            All projects
                            <span class="w-[0.8rem] h-[1rem] bg-white"></span>
                        </a>
                    </div>
                </div>    
            </div>
        </div>
     )}
</div>

<script define:vars={{ projects }}>
    // Variables globales pour le carrousel
    let currentSlide = 0;
    let slideCount = 0;
    let projectsData = projects;
    let progressTween = null;

    function initCarousel() {
        const track = document.getElementById('carousel-track');
        const slides = track?.querySelectorAll('.carousel-slide');
        const prevBtn = document.querySelector('.carousel-btn-prev');
        const nextBtn = document.querySelector('.carousel-btn-next');
        const progressBar = document.querySelector('.progress-bar');
        
        slideCount = slides?.length || 0;
        const originalSlideCount = slideCount - 2; // Soustraire les 2 slides clonés
        
        if (slideCount <= 3) return; // Au moins 3 slides (1 original + 2 clones)
        
        // Variables pour la barre de progression
        const slideDuration = 5; // 5 secondes
        
        // Commencer à l'index 1 (premier projet original)
        currentSlide = 1;
        updateTrack();
        updateProjectInfo();
        bindEvents();
       
        // S'assurer que la barre de progression commence à 0%
        if (progressBar) {
            progressBar.style.transform = 'scaleX(0)';
            progressBar.style.transformOrigin = 'left';
        }
         
        // Démarrer la barre de progression après un délai pour s'assurer que tout est prêt
        setTimeout(() => {
            startProgressBar();
        }, 500);
      
        function bindEvents() {
            prevBtn?.addEventListener('click', () => {
                // Animer rapidement la barre vers 0% puis changer de slide
                animateProgressBarToStart();
            });
            nextBtn?.addEventListener('click', () => {
                // Animer rapidement la barre jusqu'au bout puis changer de slide
                animateProgressBarToEnd();
            });
        }
      
        function goToSlide(index) {
            currentSlide = index + 1; // +1 car on commence à l'index 1
            updateTrack();
            updateProjectInfo();
            resetProgressBar();
            
            // Délai avant de démarrer la barre de progression
            setTimeout(() => {
                startProgressBar();
            }, 500);
        }
      
        function nextSlide() {
            currentSlide++;
         
            // Si on arrive au clone du premier projet (dernier slide)
            if (currentSlide >= slideCount - 1) {
                setTimeout(() => {
                    if (track) {
                        track.style.transition = 'none';
                        currentSlide = 1; // Retour au premier projet original
                        updateTrack();
                        setTimeout(() => {
                            if (track) {
                                track.style.transition = 'transform 0.5s ease-in-out';
                            }
                        }, 10);
                    }
                }, 500);
            }
         
            updateTrack();
            updateProjectInfo();
            resetProgressBar();
         
            // Délai avant de démarrer la barre de progression
            setTimeout(() => {
                startProgressBar();
            }, 500);
       }
      
        function prevSlide() {
            currentSlide--;
            
            // Si on arrive au clone du dernier projet (premier slide)
            if (currentSlide <= 0) {
                setTimeout(() => {
                    if (track) {
                        track.style.transition = 'none';
                        currentSlide = slideCount - 2; // Retour au dernier projet original
                        updateTrack();
                        setTimeout(() => {
                            if (track) {
                                track.style.transition = 'transform 0.5s ease-in-out';
                            }
                        }, 10);
                    }
                }, 500);
            }
            
            updateTrack();
            updateProjectInfo();
            resetProgressBar();
            
            // Délai avant de démarrer la barre de progression
            setTimeout(() => {
                startProgressBar();
            }, 500);
        }
      
        function updateTrack() {
            if (track) {
                track.style.transform = `translateX(-${currentSlide * 100}%)`;
            }
        }
      
        function updateProjectInfo() {
            const projectTitle = document.querySelector('.project-title');
            const projectCounter = document.querySelector('.project-counter');
            const discoverBtn = document.querySelector('.discover-btn');
            
            // Calculer l'index du projet original (en tenant compte des clones)
            let originalIndex = currentSlide - 1;
            if (originalIndex < 0) originalIndex = originalSlideCount - 1;
            if (originalIndex >= originalSlideCount) originalIndex = 0;
            
            // Mettre à jour le titre
            if (projectTitle) {
                const project = projectsData[originalIndex];
                projectTitle.textContent = project?.title || 'Projet sans titre';
            }
            
            // Mettre à jour le compteur
            if (projectCounter) {
                projectCounter.textContent = `(0${originalIndex + 1} / 0${originalSlideCount})`;
            }
            
            // Mettre à jour le lien du bouton Discover
            if (discoverBtn) {
                const project = projectsData[originalIndex];
                if (project?.slug) {
                    discoverBtn.href = `/projects/${project.slug}`;
                }
            }
        }
      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               function startProgressBar() {
                if (progressBar && window.gsap) {
                  // Arrêter l'animation précédente si elle existe
                  if (progressTween) {
                    progressTween.kill();
                  }
                  
                  // Forcer la barre à 0%
                  progressBar.style.transform = 'scaleX(0)';
                  progressBar.style.transformOrigin = 'left';
                  
                  // Animer la barre de progression avec GSAP
                  progressTween = window.gsap.to(progressBar, {
                    scaleX: 1,
                    duration: slideDuration,
                    ease: 'none',
                    onComplete: () => {
                      // Attendre un petit délai pour que la barre soit visible à 100%
                      setTimeout(() => {
                        // Changer l'origine de transformation pour la réduction de gauche à droite
                        progressBar.style.transformOrigin = 'right';
                        // Réduire la barre de la gauche vers la droite avant de changer de slide
                        window.gsap.to(progressBar, {
                          scaleX: 0,
                          duration: 0.3,
                          ease: 'power2.in',
                          onComplete: () => {
                            nextSlide();
                          }
                        });
                      }, 200);
                    }
                  });
                } else {
                  console.warn('GSAP non disponible, utilisation de l\'animation CSS');
                  // Fallback avec CSS transition
                  progressBar.style.transition = `transform ${slideDuration}s linear`;
                  progressBar.style.transform = 'scaleX(1)';
                  setTimeout(() => {
                    progressBar.style.transformOrigin = 'right';
                    progressBar.style.transition = 'transform 0.3s ease-in';
                    progressBar.style.transform = 'scaleX(0)';
                    setTimeout(() => {
                      nextSlide();
                    }, 300);
                  }, slideDuration * 1000);
                }
              }
      
                                                                                                               function resetProgressBar() {
            if (progressTween) {
              progressTween.kill();
            }
            if (progressBar) {
              progressBar.style.transform = 'scaleX(0)';
              progressBar.style.transformOrigin = 'left';
            }
          }
      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               function animateProgressBarToEnd() {
                  if (progressBar && window.gsap) {
                    // Arrêter l'animation précédente si elle existe
                    if (progressTween) {
                      progressTween.kill();
                    }
                    
                    // Animer rapidement la barre jusqu'à 100%
                    progressTween = window.gsap.to(progressBar, {
                      scaleX: 1,
                      duration: 0.15, // Animation plus rapide de 0.15 secondes
                      ease: 'power2.out',
                      onComplete: () => {
                        // Attendre un petit délai puis réduire la barre de la gauche vers la droite
                        setTimeout(() => {
                          // Changer l'origine de transformation pour la réduction de gauche à droite
                          progressBar.style.transformOrigin = 'right';
                          window.gsap.to(progressBar, {
                            scaleX: 0,
                            duration: 0.2,
                            ease: 'power2.in',
                            onComplete: () => {
                              nextSlide();
                            }
                          });
                        }, 100);
                      }
                    });
                  } else {
                    // Fallback avec CSS transition
                    progressBar.style.transition = 'transform 0.15s ease-out';
                    progressBar.style.transform = 'scaleX(1)';
                    setTimeout(() => {
                      progressBar.style.transformOrigin = 'right';
                      progressBar.style.transition = 'transform 0.2s ease-in';
                      progressBar.style.transform = 'scaleX(0)';
                      setTimeout(() => {
                        nextSlide();
                      }, 200);
                    }, 150);
                  }
                }
       
                                                                                                                               function animateProgressBarToStart() {
             if (progressBar && window.gsap) {
               // Arrêter l'animation précédente si elle existe
               if (progressTween) {
                 progressTween.kill();
               }
               
               // Animer rapidement la barre vers 0%
               progressTween = window.gsap.to(progressBar, {
                 scaleX: 0,
                 duration: 0.15, // Animation plus rapide de 0.15 secondes
                 ease: 'power2.out',
                 onComplete: () => {
                   // Attendre un petit délai puis changer de slide
                   setTimeout(() => {
                     prevSlide();
                   }, 100);
                 }
               });
             } else {
               // Fallback avec CSS transition
               progressBar.style.transition = 'transform 0.15s ease-out';
               progressBar.style.transform = 'scaleX(0)';
               setTimeout(() => {
                 prevSlide();
               }, 150);
             }
           }
       
                               function pauseProgressBar() {
           if (progressTween) {
             progressTween.kill();
           }
         }
    }
    
    // Initialiser le carrousel quand le DOM est chargé
    document.addEventListener('DOMContentLoaded', initCarousel);
</script>